/*! jQuery seeThru 1.0.0 22-04-2013 see https://github.com/m90/jquery-seeThru for details*/
(function(e){function t(t,a){var i=e("<canvas/>").attr({width:t.width,height:t.height}).get(0).getContext("2d");i.drawImage(a,0,0,t.width,t.height);for(var h=i.getImageData(0,0,t.width,t.height),n=3,r=h.data.length;r>n;n+=4)h.data[n-1]=h.data[n-2]=h.data[n-3]=h.data[n],h.data[n]=255;return h}function a(e,t){for(var a=3,i=e.data.length;i>a;a+=4)e.data[a]=t[a-1],e.data[a-3]=e.data[a-3]/(t[a-1]?t[a-1]/255:1),e.data[a-2]=e.data[a-2]/(t[a-1]?t[a-1]/255:1),e.data[a-1]=e.data[a-1]/(t[a-1]?t[a-1]/255:1)}var i={init:function(i){i||(i={});var h=e.extend({start:"autoplay",end:"loop",mask:"",alphaMask:!1,width:"",height:"",unmult:!1,shimRAF:!0},i);return h.shimRAF&&!window.requestAnimationFrame&&function(){for(var e=0,t=["ms","moz","webkit","o"],a=0;t.length>a&&!window.requestAnimationFrame;++a)window.requestAnimationFrame=window[t[a]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[t[a]+"CancelAnimationFrame"]||window[t[a]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(t){var a=(new Date).getTime(),i=Math.max(0,16-(a-e)),h=window.setTimeout(function(){t(a+i)},i);return e=a+i,h}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(e){clearTimeout(e)})}(),this.each(function(){e(this).data("seeThru")&&e.error("seeThru already initialized on selected element");var i,n=!1,r=h.alphaMask===!0;e(h.mask).length&&(i=e(h.mask)[0],"IMG"===i.tagName?(e(i).hide(),n=!0):e.error("Mask element must be <img>")),"VIDEO"===this.tagName?(e(this).bind("loadedmetadata.seeThru",function(){function s(e){w.drawImage(o,0,0,m.width,m.height*u);var t=w.getImageData(0,0,m.width,m.height),i=w.getImageData(0,m.height,m.width,m.height).data;h.unmult&&a(t,i);for(var n=3,r=t.data.length;r>n;n+=4)t.data[n]=h.alphaMask?i[n-1]:Math.max(i[n-1],i[n-2],i[n-3]);g.putImageData(t,0,0,0,0,m.width,m.height),e&&(p=requestAnimationFrame(function(){s(!0)}))}var d=e(this),o=this,u=(e(window),n?1:2),m={width:parseInt(h.width,10),height:parseInt(h.height,10)};m.height&&m.width||(d.attr("width")||d.attr("height")?d.attr("height")?d.attr("width")?(m.width=m.width||parseInt(o.width,10),m.height=m.height||parseInt(o.height,10)/u):(m.width=m.width||parseInt(o.height,10)*(o.videoWidth/Math.floor(o.videoHeight/u)),m.height=m.height||parseInt(o.height,10)):(m.width=m.width||parseInt(o.width,10),m.height=m.height||parseInt(o.width,10)/(o.videoWidth/Math.floor(o.videoHeight/u))):(m.width=m.width||o.videoWidth,m.height=m.height||o.videoHeight/u));var l=e("<canvas/>",{"class":"seeThru-buffer"}).attr({width:m.width,height:2*m.height}).hide(),c=e("<canvas/>",{"class":"seeThru-display"}).attr({width:m.width,height:m.height}),g=c[0].getContext("2d"),w=l[0].getContext("2d");c.bind("mouseenter mouseleave click mousedown mouseup mousemove mouseover hover dblclick contextmenu focus blur",function(e){d.trigger(e)}),n&&(i.width=m.width,i.height=m.height,r?w.putImageData(t(m,i),0,m.height):w.drawImage(i,0,m.height,m.width,m.height)),"stop"===h.end&&o.loop&&(o.loop=!1);var p;d.hide().data("seeThru",{staticMask:n,alphaMask:r,interval:p}).after(l,c),d.bind("play.seeThru",function(){cancelAnimationFrame(p),p=requestAnimationFrame(function(){s(!0)}),d.data("seeThru").interval=p}).bind("pause.seeThru",function(){cancelAnimationFrame(p)}),"autoplay"===h.start?d.trigger("play.seeThru"):"clicktoplay"===h.start?(o.play(),o.pause(),s(),c.one("click.seeThru",function(){o.play()})):"external"===h.start?(o.play(),o.pause(),d.bind("timeupdate.seeThru",function(){s()})):o.play(),"loop"===h.end?d.bind("ended.seeThru",function(){o.play()}):"rewind"===h.end?d.bind("ended.seeThru",function(){o.pause(),o.currentTime=0,"clicktoplay"==h.start&&c.one("click.seeThru",function(){o.play()})}):d.bind("ended.seeThru",function(){o.pause(),"clicktoplay"==h.start&&c.one("click.seeThru",function(){o.play()})})}),this.videoWidth&&this.videoHeight&&e(this).trigger("loadedmetadata.seeThru")):e.error("Selected element must be <video> element")})},updateMask:function(a){var i=e.extend({mask:""},a);return this.each(function(){var a=e(this);if(e(i.mask).length){var h=a.data("seeThru").staticMask,n=a.data("seeThru").alphaMask;if(h)if("IMG"===e(i.mask)[0].tagName){var r={width:a.width(),height:a.height()},s=e(i.mask)[0];s.width=r.width,s.height=r.height;var d=a.nextAll(".seeThru-buffer")[0].getContext("2d");n?d.putImageData(t(r,s),0,r.height):d.drawImage(s,0,r.height,r.width,r.height)}else e.error("Passed mask element must be <img>");else e.error("Cannot apply method '.updateMask()' to element with moving alpha")}else e.error("Missing parameter 'mask'")})},revert:function(){return this.each(function(){var t=e(this);t.data("seeThru")&&(cancelAnimationFrame(t.data("seeThru").interval),t.show().unbind(".seeThru").removeData("seeThru").nextAll(".seeThru-buffer:first, .seeThru-display:first").remove())})},play:function(){return this.each(function(){e(this).data("seeThru")&&this.play()})},pause:function(){return this.each(function(){e(this).data("seeThru")&&this.pause()})},rewind:function(){return this.each(function(){e(this).data("seeThru")&&(this.pause(),this.currentTime=0)})}};e.fn.seeThru=function(t){return i[t]?i[t].apply(this,Array.prototype.slice.call(arguments,1)):"object"!=typeof t&&t?(e.error("Method "+t+" does not exist on jQuery.seeThru"),undefined):i.init.apply(this,arguments)}})(jQuery);